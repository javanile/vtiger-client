#!/usr/bin/env php
<?php

error_reporting(E_ALL & ~E_NOTICE & ~E_DEPRECATED);

if (file_exists(__DIR__.'/../../../autoload.php')) {
    include_once __DIR__.'/../../../autoload.php';
} else {
    include_once __DIR__.'/../vendor/autoload.php';
}

use Javanile\VtigerClient\VtigerClient;
use Javanile\VtigerClient\System\Functions;

$defaultConfig = [
    'vtiger_url' => 'https://demo.vtiger.com/vtigercrm/',
    'username' => 'admin',
    'access_key' => 'PcC1w0COZDYbqBi',
];

$crm = trim(strval(getenv('CRM')));
$home = $_SERVER['HOME'];
$command = strtolower(trim(@$argv[1]));
if ($command == 'list' && strtolower(trim(@$argv[2])) == 'types') {
    $command = 'list types';
    array_splice($argv, 2, 1);
}
if ($command == 'crm' && strtolower(trim(@$argv[2])) == 'list') {
    $command = 'crm list';
    array_splice($argv, 2, 1);
}
if ($command == 'list' && strtolower(trim(@$argv[2])) == 'crm') {
    $command = 'crm list';
    array_splice($argv, 2, 1);
}
$envPrefix = $crm ? 'CRM='.$crm.' ' : '';
$configDir = $crm ? $home.'/.vtc/'.$crm : getcwd();
$configFile = $configDir.'/vtiger.config.json';
$config = file_exists($configFile) ? json_decode(file_get_contents($configFile), true) : $defaultConfig;

/**
 * Help
 */
if (empty($command) || $command == '--help' || $command == 'help') {
    echo <<<EOF
Usage: vtc [COMMAND] [ARG]...

Connect and exchange data over Vtiger Webservices

List of available commands
  init                      Create the file: vtiger.config.json
  config:dir                Print-out the directory of config file
  config:file               Print-out the absolute path of config file
  ping                      Test the connection to the Vtiger CRM instance
  query "QUERY"             Execute webservice query
  crm-list                  List all configured CRM instances
  list-types                List all available types
  describe MODULE [DEPTH]   Describe MODULE structure with DEPTH fields
  retrieve CRMID [DEPTH]    Retrieve an element by CRMID with 'x' (eg. 12x1020)
  create MODULE ELEMENT     Create a new record (JSON or @file.json)
  update MODULE ELEMENT     Update an existing record
  revise MODULE ELEMENT     Partially update a record

Environment
  CRM=<name>               Target a named CRM instance (~/.vtc/<name>/)

Documentation can be found at https://github.com/javanile/vtiger-client
EOF;
    echo PHP_EOL;
    exit(empty($command) ? 1 : 0);
}

/**
 * Init
 */
if ($command == 'init') {
    $configJson = json_encode($defaultConfig, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
    if (!file_exists($configFile)) {
        if (!is_dir($configDir)) {
            mkdir($configDir, 0700, true);
        }
        $size = file_put_contents($configFile, $configJson);
        if ($size) {
            echo "File '$configFile' was created.".PHP_EOL;
        } else {
            echo "[ERROR!] Problem on creating file '$configFile'.".PHP_EOL;
            echo "You must create it manually with the following content:\n$configJson\n\n".PHP_EOL;
        }
    } else {
        echo "The file '$configFile' already exists.".PHP_EOL;
    }
    echo 'Change manually the values of "vtiger_url", "username" and "access_key". You can type: \'nano $('.$envPrefix.'vtc config:file)\''.PHP_EOL;
    echo 'Than type the following command: \''.$envPrefix.'vtc ping\' to test connection.'.PHP_EOL;
    exit(0);
}

/**
 * Config
 */
if ($command == 'config:dir') {
    echo $configDir.PHP_EOL;
    exit(0);
} else if ($command == 'config:file') {
    echo $configFile.PHP_EOL;
    exit(0);
}

/**
 * CRM List
 */
if (in_array($command, ['crm-list', 'crm:list', 'crm list', 'crmlist', 'list-crm', 'list:crm', 'listcrm'])) {
    $vtcDir = $home.'/.vtc';
    $rows = [];

    // Local config (default)
    $localConfig = getcwd().'/vtiger.config.json';
    if (file_exists($localConfig)) {
        $cfg = json_decode(file_get_contents($localConfig), true);
        $rows[] = ['(local)', $cfg['vtiger_url'] ?? '-'];
    }

    // Named CRM instances
    if (is_dir($vtcDir)) {
        $dirs = scandir($vtcDir);
        sort($dirs);
        foreach ($dirs as $dir) {
            if ($dir === '.' || $dir === '..') continue;
            $cfgFile = $vtcDir.'/'.$dir.'/vtiger.config.json';
            if (file_exists($cfgFile)) {
                $cfg = json_decode(file_get_contents($cfgFile), true);
                $rows[] = [$dir, $cfg['vtiger_url'] ?? '-'];
            }
        }
    }

    if (empty($rows)) {
        echo 'No CRM instances configured. Run "vtc init" or "CRM=<name> vtc init" to create one.'.PHP_EOL;
        exit(0);
    }

    // Calculate column widths
    $w0 = max(array_map(function($r) { return strlen($r[0]); }, $rows));
    $w0 = max($w0, 4);

    echo str_pad('NAME', $w0 + 2).'URL'.PHP_EOL;
    echo str_repeat('-', $w0 + 42).PHP_EOL;
    foreach ($rows as $row) {
        echo str_pad($row[0], $w0 + 2).$row[1].PHP_EOL;
    }
    exit(0);
}

/**
 * Ping
 */
if ($command == 'ping') {
    $client = new VtigerClient(['endpoint' => $config['vtiger_url'], 'verify' => false]);
    $response = $client->login($config['username'], $config['access_key']);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Client
 */
$operationsMap = [];
if (preg_match('/([a-z]+):([a-z_]+)/i', $command, $matches)) {
    $command = $matches[1];
    $operationsMap[$command] = $matches[2];
}
$client = new VtigerClient([
    'endpoint' => $config['vtiger_url'],
    'verify' => false,
    'operationsMap' => $operationsMap
]);
$client->login($config['username'], $config['access_key']);

/**
 * Query
 */
if ($command == 'query') {
    $query = $argv[2];
    $response = $client->query($query);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Query
 */
if (in_array($command, ['listtypes', 'list-types', 'list:types', 'list types'])) {
    $response = $client->listTypes();
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Describe
 */
if ($command == 'describe') {
    $module = $argv[2];
    $depth = $argv[3] ?? 0;
    $response = $client->describe($module, $depth);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Retrieve
 */
if ($command == 'retrieve') {
    $elementId = $argv[2];
    $depth = isset($argv[3]) && $argv[3] ? intval($argv[3]) : 0;
    $response = $client->retrieve($elementId, $depth);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Parse element from arguments.
 * Supports: @file.json, inline JSON, or key=value pairs.
 *   vtc create Contacts '{"firstname":"Ravi"}'
 *   vtc create Contacts @contact.json
 *   vtc create Contacts firstname=Ravi lastname=Kumar email=ravi@example.com
 */
function parseElement($args, $offset = 3) {
    $arg = isset($args[$offset]) ? $args[$offset] : null;
    if ($arg === null) {
        return null;
    }
    // @file.json
    if ($arg[0] === '@') {
        return json_decode(file_get_contents(substr($arg, 1)), true);
    }
    // key=value pairs: if the first arg contains '=', treat all remaining args as pairs
    if (strpos($arg, '=') !== false) {
        $element = [];
        for ($i = $offset; $i < count($args); $i++) {
            $pos = strpos($args[$i], '=');
            if ($pos !== false) {
                $key = substr($args[$i], 0, $pos);
                $value = substr($args[$i], $pos + 1);
                $element[$key] = $value;
            }
        }
        return $element;
    }
    // Inline JSON
    return json_decode($arg, true);
}

/**
 * Create
 */
if ($command == 'create') {
    $module = $argv[2];
    $element = parseElement($argv, 3);
    $response = $client->create($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Update
 */
if ($command == 'update') {
    $module = $argv[2];
    if (isset($argv[3]) && strpos($argv[3], '=') === false && isset($argv[4]) && $argv[4][0] === '@') {
        $element = json_decode(file_get_contents(substr($argv[4], 1)), true);
        $element['id'] = $argv[3];
    } elseif (isset($argv[3]) && strpos($argv[3], '=') === false && isset($argv[4]) && strpos($argv[4], '=') !== false) {
        $element = parseElement($argv, 4);
        $element['id'] = $argv[3];
    } else {
        $element = parseElement($argv, 3);
    }
    $response = $client->update($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Revise
 */
if ($command == 'revise') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    if (isset($argv[3]) && strpos($argv[3], '=') === false && isset($argv[4]) && $argv[4][0] === '@') {
        $element = json_decode(file_get_contents(substr($argv[4], 1)), true);
        $element['id'] = $argv[3];
    } elseif (isset($argv[3]) && strpos($argv[3], '=') === false && isset($argv[4]) && strpos($argv[4], '=') !== false) {
        $element = parseElement($argv, 4);
        $element['id'] = $argv[3];
    } elseif (isset($argv[5])) {
        $element = [
            'id' => $argv[3],
            $argv[4] => $argv[5],
        ];
    } else {
        $element = parseElement($argv, 3);
    }
    if ($element === null) {
        die("Missing arguments.\n");
    }
    $response = $client->revise($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

echo 'Syntax error.'.PHP_EOL;
