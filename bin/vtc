#!/usr/bin/env php
<?php

if (file_exists(__DIR__.'/../../../autoload.php')) {
    require __DIR__.'/../../../autoload.php';
} else {
    require __DIR__.'/../vendor/autoload.php';
}

use Javanile\VtigerClient\VtigerClient;
use Javanile\VtigerClient\System\Functions;

$defaultConfig = [
    'vtiger_url' => 'https://demo.vtiger.com/vtigercrm/',
    'username' => 'admin',
    'access_key' => 'PcC1w0COZDYbqBi',
];

$command = strtolower(trim(@$argv[1]));
$configFile = getcwd().'/vtiger.config.json';
$config = file_exists($configFile) ? json_decode(file_get_contents($configFile), true) : $defaultConfig;

/**
 * Default
 */
if (empty($command)) {
    echo <<<EOF
Usage: vtc [COMMAND] [ARG]...

Connect and exchange data over Vtiger Webservices

List of available commands
  init                      Create the file: vtiger.config.json
  ping                      Test the connection to the Vtiger CRM instance
  query "QUERY"             Execute webservice query
  describe MODULE [DEPTH]   Describe MODULE structure with DEPTH fields
  
Documentation can be found at https://github.com/javanile/vtiger-client
EOF;
    echo PHP_EOL;
    exit(1);
}

/**
 * Init
 */
if ($command == 'init') {
    $configJson = json_encode($defaultConfig, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
    if (!file_exists($configFile)) {
        $size = file_put_contents($configFile, $configJson);
        if ($size) {
            echo "File '$configFile' was created.".PHP_EOL;
        } else {
            echo "[ERROR!] Problem on creating file '$configFile'.".PHP_EOL;
            echo "You must create it manually with the following content:\n$configJson\n\n".PHP_EOL;
        }
    } else {
        echo "The file '$configFile' already exists.".PHP_EOL;
    }
    echo 'Change manually the values of "vtiger_url", "username" and "access_key"'.PHP_EOL;
    echo 'Than type the following command: \'vtc ping\' to test connection.'.PHP_EOL;
    exit(0);
}

/**
 * Ping
 */
if ($command == 'ping') {
    $client = new VtigerClient($config['vtiger_url']);
    $response = $client->login($config['username'], $config['access_key']);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Ping
 */
if ($command == 'query') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $query = $argv[2];
    $response = $client->query($query);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Ping
 */
if ($command == 'describe') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    $depth = $argv[3] ?? 0;
    $response = $client->describe($module, $depth);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Create
 */
if ($command == 'create') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    if ($argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } else {
        $element = json_decode($argv[3], true);
    }
    $response = $client->create($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Create Custom
 */
if (substr($command, 0, 7) == 'create:') {
    $operation = substr($command, 7);
    $client = new VtigerClient([
        'endpoint' => $config['vtiger_url'],
        'operationsMap' => [
            'create' => $operation,
        ]
    ]);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    if (isset($argv[3]) && $argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } else {
        $element = json_decode($argv[3], true);
    }
    $response = $client->create($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}


/**
 * Create
 */
if ($command == 'revise') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    if (isset($argv[3]) && $argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } elseif (isset($argv[4]) && $argv[4][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[4], 1)), true);
        $element['id'] = $argv[3];
    } elseif (isset($argv[5])) {
        $element = [
            'id' => $argv[3],
            $argv[4] => $argv[5],
        ];
    } else {
        die("Missing arguments.\n");
    }
    $response = $client->revise($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

echo 'Syntax error.'.PHP_EOL;
