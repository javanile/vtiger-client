#!/usr/bin/env php
<?php

if (file_exists(__DIR__.'/../../../autoload.php')) {
    include_once __DIR__.'/../../../autoload.php';
} else {
    include_once __DIR__.'/../vendor/autoload.php';
}

use Javanile\VtigerClient\VtigerClient;
use Javanile\VtigerClient\System\Functions;

$defaultConfig = [
    'vtiger_url' => 'https://demo.vtiger.com/vtigercrm/',
    'username' => 'admin',
    'access_key' => 'PcC1w0COZDYbqBi',
];

$crm = trim(strval(getenv('CRM')));
$home = $_SERVER['HOME'];
$command = strtolower(trim(@$argv[1]));
$envPrefix = $crm ? 'CRM='.$crm.' ' : '';
$configDir = $crm ? $home.'/.vtc/'.$crm : getcwd();
$configFile = $configDir.'/vtiger.config.json';
$config = file_exists($configFile) ? json_decode(file_get_contents($configFile), true) : $defaultConfig;

/**
 * Default
 */
if (empty($command)) {
    echo <<<EOF
Usage: vtc [COMMAND] [ARG]...

Connect and exchange data over Vtiger Webservices

List of available commands
  init                      Create the file: vtiger.config.json
  config:dir                Print-out the directory of config file
  config:file               Print-out the absolute path of config file
  ping                      Test the connection to the Vtiger CRM instance  
  query "QUERY"             Execute webservice query
  listtypes                 List all available types
  describe MODULE [DEPTH]   Describe MODULE structure with DEPTH fields
  retrieve CRMID            Retrieve an element by CRMID with 'x' (eg. 12x1020)             
  create MODULE
  update
  revise
  
Documentation can be found at https://github.com/javanile/vtiger-client
EOF;
    echo PHP_EOL;
    exit(1);
}

/**
 * Init
 */
if ($command == 'init') {
    $configJson = json_encode($defaultConfig, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
    if (!file_exists($configFile)) {
        if (!is_dir($configDir)) {
            mkdir($configDir, 0700, true);
        }
        $size = file_put_contents($configFile, $configJson);
        if ($size) {
            echo "File '$configFile' was created.".PHP_EOL;
        } else {
            echo "[ERROR!] Problem on creating file '$configFile'.".PHP_EOL;
            echo "You must create it manually with the following content:\n$configJson\n\n".PHP_EOL;
        }
    } else {
        echo "The file '$configFile' already exists.".PHP_EOL;
    }
    echo 'Change manually the values of "vtiger_url", "username" and "access_key". You can type: \'nano $('.$envPrefix.'vtc config:file)\''.PHP_EOL;
    echo 'Than type the following command: \''.$envPrefix.'vtc ping\' to test connection.'.PHP_EOL;
    exit(0);
}

/**
 * Config
 */
if ($command == 'config:dir') {
    echo $configDir.PHP_EOL;
    exit(0);
} else if ($command == 'config:file') {
    echo $configFile.PHP_EOL;
    exit(0);
}

/**
 * Ping
 */
if ($command == 'ping') {
    $client = new VtigerClient(['endpoint' => $config['vtiger_url'], 'verify' => false]);
    $response = $client->login($config['username'], $config['access_key']);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Client
 */
$operationsMap = [];
if (preg_match('/([a-z]+):([a-z_]+)/i', $command, $matches)) {
    $command = $matches[1];
    $operationsMap[$command] = $matches[2];
}
$client = new VtigerClient([
    'endpoint' => $config['vtiger_url'],
    'verify' => false,
    'operationsMap' => $operationsMap
]);
$client->login($config['username'], $config['access_key']);

/**
 * Query
 */
if ($command == 'query') {
    $query = $argv[2];
    $response = $client->query($query);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Query
 */
if ($command == 'listtypes') {
    $response = $client->listTypes();
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Describe
 */
if ($command == 'describe') {
    $module = $argv[2];
    $depth = $argv[3] ?? 0;
    $response = $client->describe($module, $depth);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Retrieve
 */
if ($command == 'retrieve') {
    $elementId = $argv[2];
    $depth = isset($argv[3]) && $argv[3] ? intval($argv[3]) : 0;
    $response = $client->retrieve($elementId, $depth);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Create
 */
if ($command == 'create') {
    $module = $argv[2];
    if ($argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } else {
        $element = json_decode($argv[3], true);
    }
    $response = $client->create($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Update
 */
if ($command == 'update') {
    $module = $argv[2];
    if ($argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } elseif (isset($argv[4]) && $argv[4][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[4], 1)), true);
        $element['id'] = $argv[3];
    } else {
        $element = json_decode($argv[3], true);
    }
    $response = $client->update($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

/**
 * Revise
 */
if ($command == 'revise') {
    $client = new VtigerClient($config['vtiger_url']);
    $client->login($config['username'], $config['access_key']);
    $module = $argv[2];
    if (isset($argv[3]) && $argv[3][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[3], 1)), true);
    } elseif (isset($argv[4]) && $argv[4][0] == '@') {
        $element = json_decode(file_get_contents(substr($argv[4], 1)), true);
        $element['id'] = $argv[3];
    } elseif (isset($argv[5])) {
        $element = [
            'id' => $argv[3],
            $argv[4] => $argv[5],
        ];
    } else {
        die("Missing arguments.\n");
    }
    $response = $client->revise($module, $element);
    echo Functions::jsonEncode($response);
    exit(0);
}

echo 'Syntax error.'.PHP_EOL;
